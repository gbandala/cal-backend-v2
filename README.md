# Cal Backend üìÖ

Una aplicaci√≥n backend completa para gesti√≥n de calendarios y programaci√≥n de reuniones, inspirada en Calendly. Permite a los usuarios crear eventos, gestionar su disponibilidad e integrar con servicios como Google Calendar y Google Meet.

## üöÄ Funcionalidades Principales

### üîê Autenticaci√≥n y Usuarios
- **Registro de usuarios** con validaci√≥n de datos
- **Login seguro** con JWT tokens
- **Generaci√≥n autom√°tica** de usernames √∫nicos
- **Hash seguro** de contrase√±as con bcrypt
- **Middleware de autenticaci√≥n** con Passport JWT

### üìÖ **Gesti√≥n de Calendarios Espec√≠ficos** ‚úÖ
- **Eventos en calendarios dedicados** - Los eventos pueden crearse en calendarios espec√≠ficos de Google Calendar
- **Scope OAuth ampliado** - Incluye permisos para calendarios espec√≠ficos
- **Reuniones en calendario correcto** - Las citas van al calendario configurado del evento
- **Eliminaci√≥n inteligente** - Cancelaci√≥n desde el calendario correcto

### üìÖ Gesti√≥n de Eventos
- **Crear eventos personalizados** con t√≠tulo, descripci√≥n y duraci√≥n
- **‚úÖ Calendario espec√≠fico** - Asignar eventos a calendarios particulares
- **Eventos p√∫blicos/privados** con toggle de privacidad
- **URLs amigables** con slugs √∫nicos
- **Tipos de ubicaci√≥n** (Google Meet, Zoom, etc.)
- **Eventos p√∫blicos** accesibles sin autenticaci√≥n
- **Eliminaci√≥n en cascada** - Elimina eventos y cancela reuniones autom√°ticamente

### ‚è∞ Gesti√≥n de Disponibilidad
- **Configuraci√≥n de horarios** por d√≠a de la semana
- **Intervalos de tiempo** personalizables entre reuniones
- **Horarios disponibles/no disponibles** por d√≠a
- **Consulta p√∫blica** de disponibilidad para eventos
- **Slots de tiempo autom√°ticos** basados en duraci√≥n del evento

### üîó Integraciones
- **OAuth2 con Google** para Calendar y Meet
- **‚úÖ Scope ampliado** - Incluye permisos para calendarios espec√≠ficos
- **Gesti√≥n autom√°tica de tokens** con refresh autom√°tico
- **M√∫ltiples proveedores** (Google configurado, Zoom/Microsoft preparados)
- **Validaci√≥n de conexiones** activas
- **URLs de autorizaci√≥n** din√°micas

### ü§ù Gesti√≥n de Reuniones
- **Programaci√≥n de reuniones** por invitados
- **‚úÖ Calendario inteligente** - Usa el calendario configurado del evento
- **Creaci√≥n autom√°tica** en Google Calendar
- **Enlaces autom√°ticos** de Google Meet
- **Estados de reuni√≥n** (programada, cancelada)
- **Filtros** por estado (pr√≥ximas, pasadas, canceladas)
- **‚úÖ Cancelaci√≥n inteligente** - Elimina del calendario correcto

## üõ†Ô∏è Tecnolog√≠as Utilizadas

### Backend
- **Node.js** - Runtime de JavaScript
- **TypeScript** - Tipado est√°tico
- **Express.js** - Framework web
- **TypeORM** - ORM para base de datos

### Base de Datos
- **PostgreSQL** - Base de datos principal
- **Sincronizaci√≥n autom√°tica** en desarrollo

### Autenticaci√≥n & Seguridad
- **Passport.js** - Estrategias de autenticaci√≥n
- **JWT** - JSON Web Tokens
- **bcrypt** - Hash de contrase√±as
- **CORS** - Cross-Origin Resource Sharing

### Validaci√≥n & Transformaci√≥n
- **class-validator** - Validaci√≥n de DTOs
- **class-transformer** - Transformaci√≥n de objetos

### Integraciones Externas
- **Google APIs** - Calendar y Meet
- **OAuth2** - Autenticaci√≥n con servicios externos

### Utilidades
- **date-fns** - Manejo de fechas
- **uuid** - Generaci√≥n de IDs √∫nicos
- **js-base64** - Codificaci√≥n base64

## üìä Modelo de Datos

### Entidades Principales

#### Users (Usuarios)
```typescript
- id: UUID
- name: string
- username: string (√∫nico)
- email: string (√∫nico)
- password: string (hasheado)
- imageUrl: string (opcional)
- availability: Availability (relaci√≥n 1:1)
- events: Event[] (relaci√≥n 1:N)
- integrations: Integration[] (relaci√≥n 1:N)
- meetings: Meeting[] (relaci√≥n 1:N)
```

#### Events (Eventos) - **CON SOPORTE DE CALENDARIOS**
```typescript
- id: UUID
- title: string
- description: string (opcional)
- duration: number (minutos)
- slug: string (√∫nico por usuario)
- isPrivate: boolean
- locationType: EventLocationEnum
- calendar_id: string (‚úÖ NUEVO - default: 'primary')
- calendar_name: string (‚úÖ NUEVO - opcional)
- user: User (relaci√≥n N:1)
- meetings: Meeting[] (relaci√≥n 1:N)
```

#### Availability (Disponibilidad)
```typescript
- id: UUID
- timeGap: number (minutos entre reuniones)
- user: User (relaci√≥n 1:1)
- days: DayAvailability[] (relaci√≥n 1:N)
```

#### DayAvailability (Disponibilidad por D√≠a)
```typescript
- id: UUID
- day: DayOfWeekEnum
- startTime: Date
- endTime: Date
- isAvailable: boolean
- availability: Availability (relaci√≥n N:1)
```

#### Integration (Integraciones) - **ACTUALIZADO**
```typescript
- id: UUID
- provider: IntegrationProviderEnum
- category: IntegrationCategoryEnum
- app_type: IntegrationAppTypeEnum
- access_token: string
- refresh_token: string
- expiry_date: number
- metadata: JSON
- isConnected: boolean
- user: User (relaci√≥n N:1)
```

#### Meeting (Reuniones) - **CON CALENDARIO CORRECTO**
```typescript
- id: UUID
- guestName: string
- guestEmail: string
- additionalInfo: string
- startTime: Date
- endTime: Date
- meetLink: string
- calendarEventId: string
- calendarAppType: string
- status: MeetingStatus
- user: User (relaci√≥n N:1)
- event: Event (relaci√≥n N:1)
```

## üõ£Ô∏è API Endpoints

### üîê Autenticaci√≥n (`/api/auth`)
| M√©todo | Endpoint | Descripci√≥n | Auth Requerida |
|--------|----------|-------------|----------------|
| POST | `/register` | Registrar nuevo usuario | ‚ùå |
| POST | `/login` | Iniciar sesi√≥n | ‚ùå |

### üìÖ Eventos (`/api/event`) - **CON SOPORTE DE CALENDARIOS**
| M√©todo | Endpoint | Descripci√≥n | Auth Requerida |
|--------|----------|-------------|----------------|
| POST | `/create` | Crear nuevo evento (‚úÖ acepta calendar_id) | ‚úÖ |
| GET | `/all` | Obtener eventos del usuario (‚úÖ incluye info calendario) | ‚úÖ |
| GET | `/public/:username` | Obtener eventos p√∫blicos de un usuario | ‚ùå |
| GET | `/public/:username/:slug` | Obtener evento espec√≠fico p√∫blico | ‚ùå |
| PUT | `/toggle-privacy` | Cambiar privacidad del evento | ‚úÖ |
| DELETE | `/:eventId` | Eliminar evento (‚úÖ con cancelaci√≥n en cascada) | ‚úÖ |

### ‚è∞ Disponibilidad (`/api/availability`)
| M√©todo | Endpoint | Descripci√≥n | Auth Requerida |
|--------|----------|-------------|----------------|
| GET | `/me` | Obtener disponibilidad del usuario | ‚úÖ |
| GET | `/public/:eventId` | Obtener disponibilidad para evento p√∫blico | ‚ùå |
| PUT | `/update` | Actualizar disponibilidad | ‚úÖ |

#### ‚ú® Nuevos par√°metros de consulta
Todos los endpoints de disponibilidad ahora soportan los siguientes par√°metros:

| Par√°metro | Descripci√≥n | Ejemplo |
|-----------|-------------|---------|
| `timezone` | Zona horaria del usuario (IANA) | `America/Mexico_City`, `Europe/Bucharest` |
| `date` | Fecha espec√≠fica para slots (formato YYYY-MM-DD) | `2025-06-13` |

#### Ejemplos de uso mejorados
```bash
# Obtener disponibilidad personal en zona horaria espec√≠fica
curl -X GET http://localhost:8000/api/availability/me?timezone=America/New_York \
  -H "Authorization: Bearer tu_jwt_token"

# Obtener slots disponibles para una fecha espec√≠fica en zona horaria espec√≠fica  
curl -X GET http://localhost:8000/api/availability/public/event-id?timezone=America/Mexico_City&date=2025-06-10

# Actualizar disponibilidad desde zona horaria espec√≠fica
curl -X PUT http://localhost:8000/api/availability/update \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer tu_jwt_token" \
  -d '{...}' \
  ?timezone=Europe/Bucharest

### üîó Integraciones (`/api/integration`) - **SCOPE AMPLIADO**
| M√©todo | Endpoint | Descripci√≥n | Auth Requerida |
|--------|----------|-------------|----------------|
| GET | `/all` | Obtener todas las integraciones | ‚úÖ |
| GET | `/check/:appType` | Verificar estado de integraci√≥n | ‚úÖ |
| GET | `/connect/:appType` | Obtener URL de conexi√≥n OAuth (‚úÖ scope ampliado) | ‚úÖ |
| GET | `/google/callback` | Callback OAuth de Google | ‚ùå |

### ü§ù Reuniones (`/api/meeting`) - **CALENDARIO CORRECTO**
| M√©todo | Endpoint | Descripci√≥n | Auth Requerida |
|--------|----------|-------------|----------------|
| GET | `/user/all` | Obtener reuniones del usuario | ‚úÖ |
| POST | `/public/create` | Crear reuni√≥n (‚úÖ usa calendario del evento) | ‚ùå |
| PUT | `/cancel/:meetingId` | Cancelar reuni√≥n (‚úÖ del calendario correcto) | ‚úÖ |

## ‚úÖ Flujos Implementados

### 1. Configuraci√≥n de Calendarios Espec√≠ficos
```mermaid
graph TD
    A[Usuario conecta Google Calendar] --> B[OAuth con scopes ampliados]
    B --> C[Usuario crea evento]
    C --> D[Especifica calendar_id]
    D --> E[Evento guardado con calendario]
    E --> F[Reuniones van al calendario correcto]
```

### 2. Flujo de Reuni√≥n con Calendario Espec√≠fico
```mermaid
graph TD
    A[Invitado reserva slot] --> B[Sistema busca evento]
    B --> C[Obtiene calendar_id del evento]
    C --> D[Crea reuni√≥n en calendario espec√≠fico]
    D --> E[Google Meet generado]
    E --> F[Invitaci√≥n desde calendario correcto]
```

### 3. Eliminaci√≥n en Cascada
```mermaid
graph TD
    A[DELETE event] --> B[Buscar reuniones asociadas]
    B --> C[Cancelar cada reuni√≥n]
    C --> D[Eliminar de Google Calendar]
    D --> E[Eliminar reuniones de BD]
    E --> F[Eliminar evento]
```

## üöÄ Instalaci√≥n y Configuraci√≥n

### Prerrequisitos
- Node.js (v16 o superior)
- PostgreSQL
- Cuenta de Google Cloud Console (para integraciones)

### 1. Clonar el repositorio
```bash
git clone https://github.com/gbandala/cal-backend.git
cd cal-backend
```

### 2. Instalar dependencias
```bash
npm install
```

### 3. Configurar variables de entorno
Crear archivo `.env` en la ra√≠z del proyecto:

```env
# Configuraci√≥n del servidor
PORT=8000
NODE_ENV=development
BASE_PATH=/api

# Base de datos
DATABASE_URL=postgresql://usuario:contrase√±a@localhost:5432/cal_backend

# JWT
JWT_SECRET=tu_jwt_secret_muy_seguro
JWT_EXPIRES_IN=1d

# Google OAuth (‚úÖ SCOPE AMPLIADO)
GOOGLE_CLIENT_ID=tu_google_client_id
GOOGLE_CLIENT_SECRET=tu_google_client_secret
GOOGLE_REDIRECT_URI=http://localhost:8000/api/integration/google/callback

# Frontend
FRONTEND_ORIGIN=http://localhost:3000
FRONTEND_INTEGRATION_URL=http://localhost:3000/integrations
```

### 4. Configurar Google Cloud Console

1. Ir a [Google Cloud Console](https://console.cloud.google.com/)
2. Crear un nuevo proyecto o seleccionar uno existente
3. Habilitar las APIs:
   - Google Calendar API
   - Google Meet API
4. Crear credenciales OAuth 2.0:
   - Tipo: Aplicaci√≥n web
   - **‚úÖ Scopes necesarios**:
     - `https://www.googleapis.com/auth/calendar` (acceso completo)
     - `https://www.googleapis.com/auth/calendar.events` (eventos espec√≠ficos)
   - URIs de redirecci√≥n autorizados: `http://localhost:8000/api/integration/google/callback`
5. Copiar Client ID y Client Secret al archivo `.env`

### 5. Configurar base de datos
```bash
# Crear base de datos y ejecutar schema
psql -U usuario -d cal_backend -f cal_backend.sql
```

### 6. Ejecutar la aplicaci√≥n

#### Desarrollo
```bash
npm run dev
```

#### Producci√≥n
```bash
npm run build
npm start
```

La aplicaci√≥n estar√° disponible en `http://localhost:8000`

## üìù Ejemplos de Uso

### Registro de Usuario
```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Dr. Juan P√©rez",
    "email": "dr.juan@ejemplo.com",
    "password": "password123"
  }'
```

### ‚úÖ Crear Evento en Calendario Espec√≠fico
```bash
curl -X POST http://localhost:8000/api/event/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer tu_jwt_token" \
  -d '{
    "title": "Consulta M√©dica - 30 min",
    "description": "Consulta en calendario espec√≠fico",
    "duration": 30,
    "locationType": "GOOGLE_MEET_AND_CALENDAR",
    "calendar_id": "consultorio@gmail.com",
    "calendar_name": "Calendario Consultorio"
  }'
```

### ‚úÖ Crear Reuni√≥n (Usa calendario del evento autom√°ticamente)
```bash
curl -X POST http://localhost:8000/api/meeting/public/create \
  -H "Content-Type: application/json" \
  -d '{
    "eventId": "event-id",
    "startTime": "2025-06-02T14:00:00.000Z",
    "endTime": "2025-06-02T14:30:00.000Z",
    "guestName": "Test Guest",
    "guestEmail": "test.guest@ejemplo.com",
    "additionalInfo": "Reuni√≥n de prueba"
  }'
```

### ‚úÖ Cancelar Reuni√≥n (Del calendario correcto)
```bash
curl -X PUT http://localhost:8000/api/meeting/cancel/meeting-id \
  -H "Authorization: Bearer tu_jwt_token"
```

## üîí Seguridad

- **Autenticaci√≥n JWT** con tokens seguros
- **Hash de contrase√±as** con bcrypt y salt rounds
- **Validaci√≥n de entrada** con class-validator
- **Middleware de autenticaci√≥n** en rutas protegidas
- **Manejo seguro de tokens OAuth** con refresh autom√°tico
- **‚úÖ Validaci√≥n de ownership** - Solo el propietario puede modificar eventos
- **‚úÖ Calendario correcto** - Reuniones solo en calendarios del usuario
- **CORS configurado** para or√≠genes espec√≠ficos

## üèóÔ∏è Arquitectura

### Estructura de Carpetas
```
src/
‚îú‚îÄ‚îÄ @types/           # Tipos TypeScript personalizados
‚îú‚îÄ‚îÄ config/           # Configuraciones (DB, OAuth, etc.)
‚îú‚îÄ‚îÄ controllers/      # Controladores de las rutas
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ dto/         # Data Transfer Objects
‚îÇ   ‚îî‚îÄ‚îÄ entities/    # Entidades de TypeORM
‚îú‚îÄ‚îÄ enums/           # Enumeraciones
‚îú‚îÄ‚îÄ middlewares/     # Middlewares personalizados
‚îú‚îÄ‚îÄ routes/          # Definici√≥n de rutas
‚îú‚îÄ‚îÄ services/        # L√≥gica de negocio
‚îî‚îÄ‚îÄ utils/           # Utilidades y helpers
```

### Patr√≥n de Dise√±o
- **Arquitectura en capas** (Controllers ‚Üí Services ‚Üí Repository)
- **DTOs** para validaci√≥n de entrada
- **Entities** con TypeORM para modelado de datos
- **Middlewares** para funcionalidades transversales
- **Error handling** centralizado
- **‚úÖ Separation of concerns** - Cada servicio maneja su dominio

## üß™ Testing y Desarrollo

### Scripts Disponibles
```bash
npm run dev      # Modo desarrollo con hot-reload
npm run build    # Compilar TypeScript
npm start        # Ejecutar en producci√≥n
```

### Colecci√≥n Postman
- Requests organizados por funcionalidad
- Scripts autom√°ticos para capturar variables
- ‚úÖ Testing de calendarios espec√≠ficos incluido

### Debugging
- Logs de errores en consola
- Informaci√≥n de conexi√≥n a base de datos
- ‚úÖ Tracking de calendar_id en operaciones
- Manejo de errores HTTP estructurado

## ‚úÖ Estado Actual - Funcionalidades Completadas

### üéØ Lo que Funciona 100%
- ‚úÖ **OAuth con calendarios espec√≠ficos** - Scopes ampliados funcionando
- ‚úÖ **Eventos en calendarios dedicados** - No m√°s "primary" hardcodeado
- ‚úÖ **Reuniones en calendario correcto** - Usa calendar_id del evento
- ‚úÖ **Cancelaci√≥n inteligente** - Del calendario espec√≠fico, no primary
- ‚úÖ **Eliminaci√≥n en cascada** - Event Types ‚Üí Meetings ‚Üí Google Calendar
- ‚úÖ **Foreign key fixes** - Sin errores de integridad referencial
- ‚úÖ **Gesti√≥n de tokens** - Refresh autom√°tico funcionando

### üìã Pr√≥ximos Pasos (Roadmap)
- üöß **Cache de calendarios** - Sincronizaci√≥n autom√°tica desde Google
- üöß **Endpoints /api/calendars** - CRUD completo de calendarios
- üöß **Reasignaci√≥n de calendarios** - Cambiar calendario de eventos existentes
- üöß **Dashboard multi-calendario** - Vista unificada
- üöß **Analytics por calendario** - M√©tricas espec√≠ficas

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crear rama feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit cambios (`git commit -m 'Add nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Abrir Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia ISC.

## üë®‚Äçüíª Autor

**gbandala** - [GitHub](https://github.com/gbandala)

## üôè Agradecimientos

- Inspirado en Calendly
- Gracias a la comunidad de TypeScript y Node.js
- Google APIs por las integraciones de calendario

---

**‚úÖ Versi√≥n 2.0-beta** - Soporte b√°sico para calendarios espec√≠ficos  
**√öltima actualizaci√≥n**: Junio 2025  
**Estado**: Core functionality completada, extensiones en desarrollo